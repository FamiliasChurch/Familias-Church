<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <title>Painel Administrativo | Fam√≠lias Church</title>
    <link rel="shortcut icon" href="../assets/img/logo.jpg" type="image/x-icon">
    <link rel="stylesheet" href="../style.css">
    <link href="https://fonts.googleapis.com/css2?family=Raleway:wght@400;700&family=Smooch+Sans:wght@700&display=swap"
        rel="stylesheet">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Raleway:wght@400;500;700&family=Smooch+Sans:wght@100..900&display=swap"
        rel="stylesheet">

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script>

    <script>
        /* ==========================================================
            1. SEGURAN√áA E ACESSO
        ========================================================== */
        // CORRE√á√ÉO DA L√ìGICA DE ACESSO
        function verificarAcessoAdmin() {
            const user = netlifyIdentity.currentUser();
            if (!user) { window.location.href = "../index.html"; return; }

            const meta = user.user_metadata;
            const cargo = (meta.cargo || "").toLowerCase();
            const roles = user.app_metadata.roles || [];

            // Crit√©rio: Apostolo, Financeiro ou Moderador
            const temAcesso = ["financeiro", "ap√≥stolo", "apostolo"].includes(cargo) || roles.includes("mod");

            if (temAcesso) { // <--- REMOVI O "!" DAQUI (Se TEM acesso, entra)
                registrarAcessoFirebase(user);
                trocarAba('aba_resumo');
            } else {
                alert("Acesso Restrito!");
                window.location.href = "../perfil.html"; // Se N√ÉO tem, expulsa
            }
        }

        netlifyIdentity.on('init', user => verificarAcessoAdmin());
        netlifyIdentity.on('logout', () => window.location.href = "../index.html");
    </script>
</head>

<body class="bg-alt">
    <header>
        <div class="container header-flex"
            style="display: flex; justify-content: space-between; align-items: center; padding: 5px 0; height: 85px;">
            <a href="index.html" class="logo" style="display: flex; align-items: center;">
                <img src="./assets/img/logo.jpg" alt="Fam√≠lias Church"
                    style="height: 75px; width: auto; object-fit: contain;">
            </a>

            <nav class="nav-menu">
                <ul style="display: flex; list-style: none; gap: 25px; margin: 0; padding: 0; align-items: center;">
                    <li><a href="../index.html"
                            style="text-decoration: none; font-weight: 500; font-size: 0.85rem; color: #333;">IN√çCIO</a>
                    </li>
                    <li><a href="../index.html#sobre"
                            style="text-decoration: none; font-weight: 500; font-size: 0.85rem; color: #333;">QUEM
                            SOMOS</a>
                    </li>
                    <li><a href="../index.html#ministerios-tabs"
                            style="text-decoration: none; font-weight: 500; font-size: 0.85rem; color: #333;">MINIST√âRIOS</a>
                    </li>
                    <li><a href="../index.html#cultos"
                            style="text-decoration: none; font-weight: 500; font-size: 0.85rem; color: #333;">CULTOS</a>
                    </li>
                    <li><a href="../doacoes.html"
                            style="text-decoration: none; font-weight: 500; font-size: 0.85rem; color: #333;">DOA√á√ïES</a>
                    </li>
                    <li><a href="../eventos.html"
                            style="text-decoration: none; font-weight: 500; font-size: 0.85rem; color: #333;">EVENTOS</a>
                    </li>
                    <li><a href="../devocionais.html"
                            style="text-decoration: none; font-weight: 500; font-size: 0.85rem; color: #333;">DEVOCIONAIS</a>
                    </li>
                </ul>
            </nav>

            <div class="user-controls" style="display: flex; align-items: center; gap: 15px;">

                <div class="notification-wrapper" style="position: relative;">
                    <button class="noti-trigger" onclick="toggleNotifications()"
                        style="background:none; border:none; cursor:pointer; display: flex; align-items: center;">
                        <i class="fa-solid fa-bell" style="font-size: 1.3rem; color: #2d5a27;"></i>
                        <span id="noti-count" class="badge-count hidden">0</span>
                    </button>
                    <div id="noti-dropdown" class="noti-card">
                        <div class="noti-header"
                            style="font-weight: bold; border-bottom: 1px solid #eee; margin-bottom: 5px; padding: 10px;">
                            Notifica√ß√µes</div>
                        <div id="noti-list" class="noti-body" style="padding: 10px;">
                            <p style="font-size: 0.8rem; color: #666;">Sem novidades.</p>
                        </div>
                    </div>
                </div>

                <div class="user-menu-container" style="position: relative;">
                    <button class="profile-trigger" onclick="toggleMenu()"
                        style="background:none; border:none; cursor:pointer; padding:0; display: flex; align-items: center;">
                        <img id="userAvatarSmall" class="skeleton" src="https://www.w3schools.com/howto/img_avatar.png"
                            alt="Perfil"
                            style="width: 45px; height: 45px; border-radius: 50%; border: 2px solid #2d5a27; object-fit: cover;">
                    </button>

                    <div class="profile-card" id="profileCard">
                        <div class="card-header"
                            style="background: #f9f9f9; padding: 10px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #eee;">
                            <span id="userEmail" class="skeleton" style="font-size: 0.75rem; color: #666;">...</span>
                            <button onclick="toggleMenu()"
                                style="border:none; background:none; cursor:pointer; font-size: 1.2rem; color: #999;">&times;</button>
                        </div>
                        <div class="card-content" style="text-align: center; padding: 20px;">
                            <div class="avatar-large" style="margin-bottom: 15px;">
                                <img id="userAvatarLarge" class="skeleton"
                                    src="https://www.w3schools.com/howto/img_avatar.png" alt="Foto">
                            </div>
                            <h2 id="userName" class="skeleton" style="font-size: 1.2rem; margin: 0 0 5px 0;">Ol√°!</h2>

                            <div class="info-extra" style="font-size: 0.85rem; color: #777; margin-bottom: 15px;">
                                <p>üìÖ Idade: <strong id="userAge" class="skeleton">--</strong> anos</p>
                                <p>üõ°Ô∏è Cargo: <strong id="userRole" class="skeleton">Membro</strong></p>
                            </div>

                            <div id="admin-actions-container"></div>
                            <hr style="margin-bottom: 15px; border: 0; border-top: 1px solid #f0f0f0;">
                            <button class="action-btn-secondary" onclick="window.location.href='perfil.html'"
                                style="width:100%; margin-bottom:10px; cursor: pointer;">Meu Perfil</button>
                            <button class="action-btn logout-btn" onclick="netlifyIdentity.logout()"
                                style="width:100%; cursor:pointer;">Sair</button>
                        </div>
                    </div>
                </div>
                <div class="user-controls" style="display: flex; align-items: center; gap: 15px;">
                    <button id="btnLoginHeader" onclick="netlifyIdentity.open()" class="btn-hero"
                        style="font-size: 0.8rem; padding: 8px 15px; margin: 0;">Entrar</button>

                    <div id="userInfoHeader" class="hidden" style="display: flex; align-items: center; gap: 15px;">
                    </div>
                </div>
            </div>
        </div>
    </header>

    <main class="container" style="margin-top: 100px; min-height: 80vh;">
        <div class="perfil-header-card" style="text-align: left; padding: 25px;">
            <h1 class="titulo-secao">Painel Administrativo</h1>
            <div class="tabs-header"
                style="flex-direction: row; width: 100%; overflow-x: auto; margin-top: 20px; gap: 10px;">
                <button class="tab-btn active" onclick="trocarAba('aba_resumo', this)">üè† In√≠cio</button>
                <button class="tab-btn" onclick="trocarAba('mod_testemunhos', this)">üìù Testemunhos</button>
                <button class="tab-btn" onclick="trocarAba('financeiro_stats', this)">üí∞ Financeiro</button>
                <button class="tab-btn" onclick="trocarAba('gestao_membros', this)">üë• Membros</button>
                <button class="tab-btn" onclick="trocarAba('logs_auditoria', this)">üõ°Ô∏è Auditoria</button>
            </div>
        </div>

        <section id="aba_resumo" class="tab-content" style="margin-top: 20px;">
            <div class="hero-btns" style="justify-content: flex-start; gap: 20px; flex-wrap: wrap;">
                <div class="card" style="min-width: 200px; padding: 20px; border-top: 5px solid var(--cor-primaria);">
                    <h3>Membros</h3>
                    <div id="est-total-membros" class="horario">...</div>
                    <p class="nome-culto">Total cadastrado</p>
                </div>
                <div class="card" style="min-width: 200px; padding: 20px; border-top: 5px solid #2a5f50;">
                    <h3>Relat√≥rios</h3>
                    <button onclick="gerarRelatorio()" class="btn-hero"
                        style="width: 100%; margin-top: 15px; font-size: 0.8rem;">üìß Enviar Backup</button>
                    <p id="status-relatorio" style="font-size: 0.6rem; margin-top: 5px;"></p>
                </div>
            </div>
        </section>

        <section id="financeiro_stats" class="tab-content perfil-section" style="margin-top: 20px; display: none;">
            <h3>üìä Crescimento de Contribui√ß√µes</h3>
            <div style="margin-bottom: 15px;">
                <select id="filtroAno" onchange="carregarGraficoCrescimento(this.value)"
                    style="padding: 5px 12px; border-radius: 8px;">
                    <option value="todos">Todos os Anos</option>
                    <option value="2024">2024</option>
                    <option value="2025" selected>2025</option>
                </select>
            </div>
            <div class="card" style="padding: 20px; background: white; border-radius: 12px; margin-bottom: 20px;">
                <canvas id="meuGrafico" style="max-height: 400px;"></canvas>
            </div>
            <h3>üí∞ D√≠zimos Pendentes</h3>
            <div id="lista-financeiro" class="lista-registros"></div>
        </section>

        <section id="mod_testemunhos" class="tab-content perfil-section" style="display: none; margin-top: 20px;">
            <h3>üìù Testemunhos Pendentes</h3>
            <div id="lista-moderacao" class="grid-testemunhos"></div>
        </section>

        <section id="gestao_membros" class="tab-content perfil-section" style="display: none; margin-top: 20px;">
            <h3>üë• Lista de Contatos</h3>
            <div id="lista-membros-admin" class="lista-registros"></div>
        </section>

        <section id="logs_auditoria" class="tab-content perfil-section" style="display: none; margin-top: 20px;">
            <h3>üõ°Ô∏è Hist√≥rico de Auditoria</h3>
            <table style="width: 100%; border-collapse: collapse;">
                <tbody id="corpo-tabela-logs"></tbody>
            </table>
        </section>
    </main>

    <footer id="footer" class="footer-moderno"></footer>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

    <script src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script>

    <script src="../script.js"></script>
    <script>
        let instanciaGrafico = null;

        function trocarAba(idAba, btn) {
            document.querySelectorAll('.tab-content').forEach(s => s.style.display = 'none');
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.getElementById(idAba).style.display = 'block';
            if (btn) btn.classList.add('active');

            // Gatilhos de carregamento
            if (idAba === 'aba_resumo') carregarResumoEstatisticas();
            if (idAba === 'mod_testemunhos') carregarPendentes();
            if (idAba === 'financeiro_stats') { carregarDizimosPendentes(); carregarGraficoCrescimento('2025'); }
            if (idAba === 'gestao_membros') carregarMembrosAdmin();
            if (idAba === 'logs_auditoria') carregarTabelaLogs();
        }

        async function carregarResumoEstatisticas() {
            const resMembros = await fetch('../content/membros_all.json?v=' + Date.now());
            const membros = await resMembros.json();
            document.getElementById('est-total-membros').innerText = membros.length;
        }

        /* ... Insira aqui as fun√ß√µes carregarGraficoCrescimento, carregarDizimosPendentes, carregarTabelaLogs, etc ... */
    </script>
</body>

</html>